#!/usr/bin/expect -f

# Usage: PROD_PASS=heslo ./scripts/deploy-production.expect /cesta/k/build/dobity-baterky

set timeout 600

if { [llength $argv] < 1 } {
    puts "ERROR: MusÃ­Å¡ pÅ™edat cestu k build sloÅ¾ce (napÅ™. build/dobity-baterky)."
    exit 2
}

set local_dir [lindex $argv 0]

if { ! [file isdirectory $local_dir] } {
    puts "ERROR: SloÅ¾ka $local_dir neexistuje nebo nenÃ­ adresÃ¡Å™."
    exit 2
}

if { ! [info exists env(PROD_PASS)] || $env(PROD_PASS) eq "" } {
    puts "ERROR: Nastav promÄ›nnou PROD_PASS s passphrase/heslem pro klÃ­Ä ondraplas-default."
    exit 2
}

set password $env(PROD_PASS)
set timestamp [clock format [clock seconds] -format "%Y%m%d%H%M%S"]
set backup_dir "dobity-baterky.backup-$timestamp"

set user "dobitybaterky.wordpress.com"
set host "sftp.wp.com"
set identity "~/.ssh/id_ed25519_wpcom"

spawn sftp -oIdentityFile=$identity -oIdentitiesOnly=yes ${user}@${host}

expect "Enter passphrase for key"
send "$password\r"

expect "sftp>"
send "cd wp-content/plugins\r"

expect "sftp>"
# VytvoÅ™it backup (pokud plugin existuje)
puts "ðŸ“¦ VytvÃ¡Å™Ã­m backup: $backup_dir"
send "rename dobity-baterky $backup_dir\r"
expect {
    -re "No such file" {
        puts "âš ï¸  WARNING: Plugin sloÅ¾ka 'dobity-baterky' neexistuje na produkci (prvnÃ­ nasazenÃ­?)"
        expect "sftp>"
    }
    "sftp>" {
        puts "âœ… Backup vytvoÅ™en: $backup_dir"
    }
    timeout {
        puts "âš ï¸  WARNING: Timeout pÅ™i vytvÃ¡Å™enÃ­ backupu, pokraÄuji..."
    }
}

expect "sftp>"
send "mkdir dobity-baterky\r"

expect "sftp>"
send "lcd $local_dir\r"

expect "sftp>"
send "put -r * dobity-baterky/\r"

expect "sftp>"
puts "âœ… Nasazeno na produkci. ZÃ¡loha: $backup_dir"
send "exit\r"

expect eof
