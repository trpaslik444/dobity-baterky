#!/usr/bin/expect -f

# Usage: STAGING_PASS=heslo ./scripts/deploy-staging-safe.expect /cesta/k/build/dobity-baterky

set timeout 900

if { [llength $argv] < 1 } {
    puts "ERROR: MusÃ­Å¡ pÅ™edat cestu k build sloÅ¾ce (napÅ™. build/dobity-baterky)."
    exit 2
}

set local_dir [lindex $argv 0]
set local_dir_escaped [string map {" " "\\ "} $local_dir]

# Zjistit PROJECT_ROOT z local_dir
set PROJECT_ROOT [file dirname [file dirname [file normalize $local_dir]]]

# LogovÃ¡nÃ­ pÅ™Ã­mo z expectu
if { [info exists env(DEPLOY_LOG)] && $env(DEPLOY_LOG) ne "" } {
    log_file -a $env(DEPLOY_LOG)
}

# DetailnÃ­ debug log
set debug_log "$PROJECT_ROOT/DEPLOY_DEBUG.log"
set debug_fd [open $debug_log w]
puts $debug_fd "=== DEPLOY DEBUG LOG ==="
puts $debug_fd "Started: [clock format [clock seconds]]"
puts $debug_fd "PROJECT_ROOT: $PROJECT_ROOT"
puts $debug_fd "Local dir: $local_dir"
puts $debug_fd ""
flush $debug_fd

# Helper pro debug logging
proc debug_log {msg} {
    global debug_fd
    puts $debug_fd "[clock format [clock seconds] -format {%H:%M:%S}] $msg"
    flush $debug_fd
    puts "DEBUG: $msg"
}

if { ! [file isdirectory $local_dir] } {
    puts "ERROR: SloÅ¾ka $local_dir neexistuje nebo nenÃ­ adresÃ¡Å™."
    exit 2
}

if { ! [info exists env(STAGING_PASS)] || $env(STAGING_PASS) eq "" } {
    puts "ERROR: Nastav promÄ›nnou STAGING_PASS s passphrase/heslem pro klÃ­Ä."
    exit 2
}

set password $env(STAGING_PASS)
set timestamp [clock format [clock seconds] -format "%Y%m%d%H%M%S"]
set backup_dir "dobity-baterky.backup-$timestamp"

set user "staging-f576-dobitybaterky.wordpress.com"
set sftp_host "sftp.wp.com"
set ssh_host "ssh.wp.com"
set identity "~/.ssh/id_ed25519_wpcom"

# List kandidÃ¡tnÃ­ch cest pro wp-content/plugins
set plugin_paths [list "/srv/htdocs/wp-content/plugins" "/wordpress/core/6.9/wp-content/plugins" "/public_html/wp-content/plugins" "/home/$user/public_html/wp-content/plugins"]

puts "ğŸ” Krok 1: Kontroluji aktuÃ¡lnÃ­ stav pluginu..."

# Krok 1: Kontrola stavu pluginu pÅ™es SSH
set wp_root_cmd {for p in /srv/htdocs /wordpress/core/6.9 /public_html ~/public_html; do if [ -f "$p/wp-config.php" ]; then cd "$p"; break; fi; done; pwd}
set check_cmd {for p in /srv/htdocs /wordpress/core/6.9 /public_html ~/public_html; do if [ -f "$p/wp-config.php" ]; then cd "$p"; break; fi; done; wp plugin list --name=dobity-baterky --format=json 2>/dev/null || echo "WP-CLI_ERROR"}
spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $check_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    eof {
        catch wait result
    }
}

# Krok 2: Deaktivovat plugin pÅ™es SSH
puts ""
puts "ğŸ”„ Krok 2: Deaktivuji plugin (pro bezpeÄnÃ© nahrazenÃ­)..."
set deactivate_cmd {for p in /srv/htdocs /wordpress/core/6.9 /public_html ~/public_html; do if [ -f "$p/wp-config.php" ]; then cd "$p"; break; fi; done; wp plugin deactivate dobity-baterky 2>&1 || echo "DEACTIVATE_ERROR"}
spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $deactivate_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    eof {
        catch wait result
    }
}

# Krok 2.5: NajÃ­t sprÃ¡vnou cestu k pluginu pÅ™es SSH
puts ""
puts "ğŸ” Krok 2.5: ZjiÅ¡Å¥uji cestu k pluginu..."

set plugins_dir ""

set find_plugins_cmd {if [ -f /srv/htdocs/wp-content/plugins/dobity-baterky/dobity-baterky.php ]; then echo "PLUGINS_DIR=/srv/htdocs/wp-content/plugins"; elif [ -f /wordpress/core/6.9/wp-content/plugins/dobity-baterky/dobity-baterky.php ]; then echo "PLUGINS_DIR=/wordpress/core/6.9/wp-content/plugins"; elif [ -f /public_html/wp-content/plugins/dobity-baterky/dobity-baterky.php ]; then echo "PLUGINS_DIR=/public_html/wp-content/plugins"; elif [ -f "$HOME/public_html/wp-content/plugins/dobity-baterky/dobity-baterky.php" ]; then echo "PLUGINS_DIR=$HOME/public_html/wp-content/plugins"; else echo "PLUGINS_DIR=NOT_FOUND"; fi}

spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $find_plugins_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    -re "PLUGINS_DIR=(.+)\r\n" {
        set plugins_dir $expect_out(1,string)
        exp_continue
    }
    -re "PLUGINS_DIR=(.+)$" {
        set plugins_dir $expect_out(1,string)
        exp_continue
    }
    eof {
        catch wait result
    }
}

# OÄistit plugins_dir od whitespace
set plugins_dir [string trim $plugins_dir]

if { $plugins_dir eq "" || $plugins_dir eq "NOT_FOUND" } {
    debug_log "âŒ Plugin dobity-baterky nebyl nalezen na serveru."
    puts "âŒ Plugin dobity-baterky nebyl nalezen na serveru."
    close $debug_fd
    exit 1
}

debug_log "âœ… Plugins dir nalezen: $plugins_dir"
puts "âœ… Plugins dir nalezen: $plugins_dir"

# Krok 3: ZÃ¡loha a nahrÃ¡nÃ­ novÃ© verze pÅ™es SFTP
puts ""
puts "ğŸ’¾ Krok 3: ZÃ¡lohuji aktuÃ¡lnÃ­ verzi a nahrÃ¡vÃ¡m novou..."

spawn sftp -oIdentityFile=$identity -oIdentitiesOnly=yes -oServerAliveInterval=30 -oServerAliveCountMax=3 ${user}@${sftp_host}

expect "Enter passphrase for key"
send "$password\r"

# Helper funkce pro oÄekÃ¡vÃ¡nÃ­ SFTP promptu s timeoutem
proc expect_sftp_prompt {} {
    global debug_fd
    if { [info exists debug_fd] } {
        puts $debug_fd "[clock format [clock seconds] -format {%H:%M:%S}] expect_sftp_prompt: ÄekÃ¡m na sftp>"
        flush $debug_fd
    }
    expect {
        "sftp>" { 
            if { [info exists debug_fd] } {
                puts $debug_fd "[clock format [clock seconds] -format {%H:%M:%S}] expect_sftp_prompt: dostal jsem sftp>"
                flush $debug_fd
            }
            return 0 
        }
        eof {
            puts "âŒ SFTP spojenÃ­ bylo ukonÄeno."
            return 2
        }
        timeout {
            if { [info exists debug_fd] } {
                puts $debug_fd "[clock format [clock seconds] -format {%H:%M:%S}] expect_sftp_prompt: TIMEOUT"
                flush $debug_fd
            }
            puts "âŒ Timeout ÄekÃ¡nÃ­ na sftp prompt"
            return 1
        }
    }
}

proc restore_backup_via_ssh {} {
    global backup_dir plugins_dir user ssh_host identity password
    if { $backup_dir eq "" || $plugins_dir eq "" } {
        return
    }
    set restore_cmd [format {cd %s && if \[ -d %s \]; then rm -rf dobity-baterky; mv %s dobity-baterky; echo RESTORED; else echo NO_RESTORE; fi} $plugins_dir $backup_dir $backup_dir]
    spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $restore_cmd
    expect {
        "Enter passphrase for key" {
            send "$password\r"
            exp_continue
        }
        eof {
            catch wait result
        }
    }
}

proc handle_sftp_failure {} {
    global backup_created
    if { [info exists backup_created] && $backup_created == 1 } {
        restore_backup_via_ssh
    }
    send "exit\r"
    exit 1
}

# PÅ™epnout se do sprÃ¡vnÃ© plugins sloÅ¾ky
expect "sftp>"
debug_log "PÅ™epÃ­nÃ¡m se do plugins dir: $plugins_dir"
puts "â¡ï¸  sftp: cd $plugins_dir"
send "cd $plugins_dir\r"
expect {
    -re "No such file|Couldn't|Failure|not found" {
        debug_log "âŒ Nelze vstoupit do $plugins_dir na serveru"
        puts "âŒ Nelze vstoupit do $plugins_dir na serveru"
        close $debug_fd
        send "exit\r"
        exit 1
    }
    "sftp>" {
        debug_log "âœ… Jsme v plugins dir: $plugins_dir"
    }
    timeout {
        debug_log "TIMEOUT pÅ™i cd $plugins_dir"
        puts "âŒ Timeout pÅ™i pÅ™epnutÃ­ do $plugins_dir"
        close $debug_fd
        send "exit\r"
        exit 1
    }
}

# Zkontrolovat, jestli plugin existuje
set backup_exists 0
set backup_created 0
debug_log "Kontroluji existenci pluginu dobity-baterky"
puts "â¡ï¸  sftp: ls dobity-baterky"
send "ls dobity-baterky\r"
expect {
    -re "Can't ls|not found|Cannot find|No such file" {
        debug_log "âŒ Plugin sloÅ¾ka neexistuje v $plugins_dir"
        puts "âŒ Plugin sloÅ¾ka neexistuje v $plugins_dir"
        send "exit\r"
        exit 1
    }
    "sftp>" {
        debug_log "âœ… Plugin sloÅ¾ka existuje"
        puts "âœ… Plugin sloÅ¾ka existuje"
        set backup_exists 1
    }
    timeout {
        debug_log "TIMEOUT pÅ™i ls dobity-baterky"
        puts "âŒ Timeout pÅ™i kontrole existence pluginu"
        send "exit\r"
        exit 1
    }
}

debug_log "backup_exists: $backup_exists"

# Pokud plugin existuje, vytvoÅ™Ã­me zÃ¡lohu
if { $backup_exists == 1 } {
    puts "ğŸ“¦ VytvÃ¡Å™Ã­m backup: $backup_dir"
    puts "â¡ï¸  sftp: rename dobity-baterky $backup_dir"
    send "rename dobity-baterky $backup_dir\r"
    expect {
        -re "Cannot find|No such file|not found" {
            puts "âŒ ZÃ¡loha selhala (sloÅ¾ka zmizela). PÅ™eruÅ¡uju deploy."
            send "exit\r"
            exit 1
        }
        -re "Failure|Couldn't|not permitted|Permission denied" {
            puts "âŒ ZÃ¡loha selhala â€“ pÅ™eruÅ¡uju deploy."
            send "exit\r"
            exit 1
        }
    "sftp>" {
        puts "âœ… ZÃ¡loha vytvoÅ™ena: $backup_dir"
        set backup_exists 1
        set backup_created 1
    }
        timeout {
            puts "âŒ Timeout pÅ™i vytvÃ¡Å™enÃ­ zÃ¡lohy â€“ pÅ™eruÅ¡uju deploy."
            send "exit\r"
            exit 1
        }
    }
}

# VytvoÅ™it novou sloÅ¾ku po ÃºspÄ›Å¡nÃ© zÃ¡loze
puts "â¡ï¸  sftp: mkdir dobity-baterky"
send "mkdir dobity-baterky\r"
expect {
    -re "Cannot create|already exists|exists" {
        # SloÅ¾ka uÅ¾ existuje (nebo jinÃ¡ chyba), pokraÄujeme
    }
    "sftp>" {
        # SloÅ¾ka byla ÃºspÄ›Å¡nÄ› vytvoÅ™ena
    }
    timeout {
        puts "âŒ Timeout pÅ™i vytvÃ¡Å™enÃ­ sloÅ¾ky"
        handle_sftp_failure
    }
}

# PÅ™epnout se do cÃ­lovÃ© sloÅ¾ky na serveru
puts "â¡ï¸  sftp: cd dobity-baterky"
send "cd dobity-baterky\r"
expect {
    -re "No such file|Couldn't|Failure" {
        puts "âŒ Nelze vstoupit do dobity-baterky na serveru"
        handle_sftp_failure
    }
    "sftp>" {
        # OK
    }
    timeout {
        puts "âŒ Timeout pÅ™i pÅ™epnutÃ­ do dobity-baterky"
        handle_sftp_failure
    }
}

# Pro jistotu ovÄ›Å™, Å¾e jsme v cÃ­lovÃ© sloÅ¾ce
puts "â¡ï¸  sftp: pwd"
send "pwd\r"
expect {
    -re "dobity-baterky" {
        # OK
        if { [expect_sftp_prompt] != 0 } { handle_sftp_failure }
    }
    "sftp>" {
        puts "âŒ Remote cwd nenÃ­ dobity-baterky"
        handle_sftp_failure
    }
    timeout {
        puts "âŒ Timeout pÅ™i ovÄ›Å™ovÃ¡nÃ­ pwd"
        handle_sftp_failure
    }
}

# PÅ™epnout lokÃ¡lnÃ­ adresÃ¡Å™
puts "â¡ï¸  sftp: lcd \"$local_dir\""
send "lcd $local_dir_escaped\r"

puts "â¡ï¸  sftp: lpwd"
send "lpwd\r"
expect {
    -re {Local working directory: (.+)} {
        set lpwd_output $expect_out(1,string)
        if { [string match "*$local_dir*" $lpwd_output] } {
            # OK
        } else {
            puts "âŒ LCD selhalo nebo je Å¡patnÃ¡ cesta: $local_dir"
            handle_sftp_failure
        }
    }
    "sftp>" {
        puts "âŒ LCD selhalo nebo je Å¡patnÃ¡ cesta: $local_dir"
        handle_sftp_failure
    }
    timeout {
        puts "âŒ LCD timeout â€“ nelze ovÄ›Å™it lpwd"
        handle_sftp_failure
    }
}

# Upload do current dir
puts "ğŸ“¤ NahrÃ¡vÃ¡m soubory..."
puts "ğŸ“„ LokÃ¡lnÃ­ loader.js:"
exec sh -c "ls -lh \"$local_dir/assets/map/loader.js\" && grep \"const CACHE_BUST_TAG\" \"$local_dir/assets/map/loader.js\" || true"
puts ""

# U put nastav delÅ¡Ã­ timeout
set old_timeout $timeout
set timeout 1800
puts "â¬†ï¸  sftp: put -r * (mÅ¯Å¾e chvÃ­li trvat)"
send "put -r *\r"
expect {
    "sftp>" {
        puts "âœ… Upload hotovÃ½"
    }
    timeout {
        puts "âŒ Upload timeout"
        send "\003"
        handle_sftp_failure
    }
}
set timeout $old_timeout

# OvÄ›Å™, Å¾e se na serveru zmÄ›nil loader.js
expect "sftp>"
puts "ğŸ” OvÄ›Å™uji loader.js po uploadu"
puts "â¡ï¸  sftp: ls -lh dobity-baterky/assets/map/loader.js"
send "ls -lh dobity-baterky/assets/map/loader.js\r"
expect "sftp>"
puts "âœ… Soubory nahrÃ¡ny a ovÄ›Å™eny"
send "exit\r"

expect eof

# Krok 4: Aktivovat plugin znovu pÅ™es SSH a vymazat cache
puts ""
puts "âœ… Krok 4: Aktivuji plugin znovu a maÅ¾u cache..."

set activate_cmd {for p in /srv/htdocs /wordpress/core/6.9 /public_html ~/public_html; do if [ -f "$p/wp-config.php" ]; then cd "$p"; break; fi; done; wp plugin activate dobity-baterky 2>&1; wp cache flush 2>&1; wp rewrite flush 2>&1}
spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $activate_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    "Success: Activated" {
        puts "âœ… Plugin aktivovÃ¡n"
        exp_continue
    }
    "Success: The cache was flushed" {
        puts "âœ… Cache vymazÃ¡na"
        exp_continue
    }
    "Success: Rewrite rules flushed" {
        puts "âœ… Rewrite rules aktualizovÃ¡ny"
        exp_continue
    }
    eof {
        catch wait result
    }
}

puts ""
puts "âœ… Hotovo! Plugin nasazen a aktivovÃ¡n."
puts "ğŸ“¦ ZÃ¡loha: $backup_dir"
puts "ğŸŒ OvÄ›Å™ staging na https://staging-f576-dobitybaterky.wpcomstaging.com/"
