#!/usr/bin/expect -f

# Usage: STAGING_PASS=heslo ./scripts/deploy-staging-safe.expect /cesta/k/build/dobity-baterky

set timeout 900

if { [llength $argv] < 1 } {
    puts "ERROR: MusÃ­Å¡ pÅ™edat cestu k build sloÅ¾ce (napÅ™. build/dobity-baterky)."
    exit 2
}

set local_dir [lindex $argv 0]

if { ! [file isdirectory $local_dir] } {
    puts "ERROR: SloÅ¾ka $local_dir neexistuje nebo nenÃ­ adresÃ¡Å™."
    exit 2
}

if { ! [info exists env(STAGING_PASS)] || $env(STAGING_PASS) eq "" } {
    puts "ERROR: Nastav promÄ›nnou STAGING_PASS s passphrase/heslem pro klÃ­Ä."
    exit 2
}

set password $env(STAGING_PASS)
set timestamp [clock format [clock seconds] -format "%Y%m%d%H%M%S"]
set backup_dir "dobity-baterky.backup-$timestamp"

set user "staging-f576-dobitybaterky.wordpress.com"
set sftp_host "sftp.wp.com"
set ssh_host "ssh.wp.com"
set identity "~/.ssh/id_ed25519_wpcom"

puts "ğŸ” Krok 1: Kontroluji aktuÃ¡lnÃ­ stav pluginu..."

# Krok 1: Kontrola stavu pluginu pÅ™es SSH
set check_cmd {cd /srv/htdocs 2>/dev/null || cd ~/public_html 2>/dev/null || pwd; wp plugin list --name=dobity-baterky --format=json 2>/dev/null || echo "WP-CLI_ERROR"}
spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $check_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    eof {
        catch wait result
    }
}

# Krok 2: Deaktivovat plugin pÅ™es SSH
puts ""
puts "ğŸ”„ Krok 2: Deaktivuji plugin (pro bezpeÄnÃ© nahrazenÃ­)..."
set deactivate_cmd {cd /srv/htdocs 2>/dev/null || cd ~/public_html 2>/dev/null; wp plugin deactivate dobity-baterky 2>&1 || echo "DEACTIVATE_ERROR"}
spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $deactivate_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    eof {
        catch wait result
    }
}

# Krok 3: ZÃ¡loha a nahrÃ¡nÃ­ novÃ© verze pÅ™es SFTP
puts ""
puts "ğŸ’¾ Krok 3: ZÃ¡lohuji aktuÃ¡lnÃ­ verzi a nahrÃ¡vÃ¡m novou..."

spawn sftp -oIdentityFile=$identity -oIdentitiesOnly=yes ${user}@${sftp_host}

expect "Enter passphrase for key"
send "$password\r"

expect "sftp>"
send "cd wp-content/plugins\r"

expect "sftp>"
# Zkontrolovat, zda existuje aktuÃ¡lnÃ­ verze
puts "ğŸ” Kontroluji existenci aktuÃ¡lnÃ­ verze pluginu..."
send "ls dobity-baterky\r"

set backup_exists 1
expect {
    -re "Cannot find|No such file|not found" {
        puts "âš ï¸  AktuÃ¡lnÃ­ plugin sloÅ¾ka neexistuje, vytvÃ¡Å™Ã­m novou..."
        expect "sftp>"
        set backup_exists 0
    }
    "sftp>" {
        # Pokud jsme dostali pÅ™Ã­mo prompt, sloÅ¾ka pravdÄ›podobnÄ› existuje
        # (vÃ½pis souborÅ¯ mÅ¯Å¾e bÃ½t prÃ¡zdnÃ½, ale sloÅ¾ka je tam)
        # ZkusÃ­me vytvoÅ™it zÃ¡lohu
        puts "ğŸ“¦ VytvÃ¡Å™Ã­m backup: $backup_dir"
        send "rename dobity-baterky $backup_dir\r"
        expect {
            -re "Cannot find|No such file|not found" {
                puts "âš ï¸  SloÅ¾ka neexistuje, vytvÃ¡Å™Ã­m novou..."
                expect "sftp>"
                set backup_exists 0
            }
            "sftp>" {
                puts "âœ… ZÃ¡loha vytvoÅ™ena: $backup_dir"
                set backup_exists 1
            }
            timeout {
                puts "âš ï¸  Timeout pÅ™i vytvÃ¡Å™enÃ­ zÃ¡lohy, pokraÄuji s vytvoÅ™enÃ­m novÃ©..."
                expect "sftp>"
                set backup_exists 0
            }
        }
    }
    timeout {
        puts "âš ï¸  Timeout pÅ™i kontrole existence sloÅ¾ky, pokraÄuji s vytvoÅ™enÃ­m novÃ©..."
        expect "sftp>"
        set backup_exists 0
    }
}

# VytvoÅ™it novou sloÅ¾ku (vÅ¾dy po vytvoÅ™enÃ­ zÃ¡lohy, nebo pÅ™i prvnÃ­m deployi)
expect "sftp>"
send "mkdir dobity-baterky\r"
expect {
    -re "Cannot create|already exists|exists" {
        # SloÅ¾ka uÅ¾ existuje (nebo jinÃ¡ chyba), pokraÄujeme
        expect "sftp>"
    }
    "sftp>" {
        # SloÅ¾ka byla ÃºspÄ›Å¡nÄ› vytvoÅ™ena
    }
}
send "lcd $local_dir\r"

expect "sftp>"
puts "ğŸ“¤ NahrÃ¡vÃ¡m soubory..."
send "put -r * dobity-baterky/\r"

expect "sftp>"
puts "âœ… Soubory nahrÃ¡ny"
send "exit\r"

expect eof

# Krok 4: Aktivovat plugin znovu pÅ™es SSH a vymazat cache
puts ""
puts "âœ… Krok 4: Aktivuji plugin znovu a maÅ¾u cache..."

set activate_cmd {cd /srv/htdocs 2>/dev/null || cd ~/public_html 2>/dev/null; wp plugin activate dobity-baterky 2>&1; wp cache flush 2>&1; wp rewrite flush 2>&1}
spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $activate_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    "Success: Activated" {
        puts "âœ… Plugin aktivovÃ¡n"
        exp_continue
    }
    "Success: The cache was flushed" {
        puts "âœ… Cache vymazÃ¡na"
        exp_continue
    }
    "Success: Rewrite rules flushed" {
        puts "âœ… Rewrite rules aktualizovÃ¡ny"
        exp_continue
    }
    eof {
        catch wait result
    }
}

puts ""
puts "âœ… Hotovo! Plugin nasazen a aktivovÃ¡n."
puts "ğŸ“¦ ZÃ¡loha: $backup_dir"
puts "ğŸŒ OvÄ›Å™ staging na https://staging-f576-dobitybaterky.wpcomstaging.com/"
