#!/usr/bin/expect -f

# OptimalizovanÃ½ import skript (staging/production)
# SpouÅ¡tÃ­ import v pozadÃ­ pomocÃ­ nohup pro zabrÃ¡nÄ›nÃ­ timeoutÅ¯m

# Usage:
#   STAGING_PASS=heslo ./scripts/import-csv-production.expect /cesta/k/file.csv
#   IMPORT_ENV=production PROD_PASS=heslo ./scripts/import-csv-production.expect /cesta/k/file.csv

set timeout 300  ;# Pouze pro nahrÃ¡nÃ­ souborÅ¯, ne pro import samotnÃ½

if { [llength $argv] < 1 } {
    puts "ERROR: MusÃ­Å¡ pÅ™edat cestu k CSV souboru."
    exit 2
}

set csv_file [lindex $argv 0]

if { ! [file exists $csv_file] } {
    puts "ERROR: CSV soubor $csv_file neexistuje."
    exit 2
}

set import_env "staging"
if { [info exists env(IMPORT_ENV)] && $env(IMPORT_ENV) ne "" } {
    set import_env [string tolower $env(IMPORT_ENV)]
}

if { $import_env ne "staging" && $import_env ne "production" } {
    puts "ERROR: IMPORT_ENV musÃ­ bÃ½t 'staging' nebo 'production'."
    exit 2
}

if { $import_env eq "production" } {
    set pass_var "PROD_PASS"
    set user "dobitybaterky.wordpress.com"
    set sftp_host "sftp.wp.com"
    set ssh_host "ssh.wp.com"
    set identity "~/.ssh/id_ed25519_wpcom"
    set env_label "produkce"
} else {
    set pass_var "STAGING_PASS"
    set user "staging-f576-dobitybaterky.wordpress.com"
    set sftp_host "sftp.wp.com"
    set ssh_host "ssh.wp.com"
    set identity "~/.ssh/id_ed25519_wpcom"
    set env_label "staging"
}

set password ""
if { [info exists env(IMPORT_PASS)] && $env(IMPORT_PASS) ne "" } {
    set password $env(IMPORT_PASS)
} elseif { [info exists env($pass_var)] && $env($pass_var) ne "" } {
    set password $env($pass_var)
}

if { $password eq "" } {
    puts "ERROR: NenÃ­ nastaveno heslo pro $env_label. Nastav IMPORT_PASS nebo $pass_var."
    exit 2
}
set timestamp [clock format [clock seconds] -format "%Y%m%d%H%M%S"]
set remote_csv_path "/tmp/poi_import_${timestamp}.csv"
set log_file "/tmp/poi_import_${timestamp}.log"

set process_nearby_limit "50"
if { [info exists env(PROCESS_NEARBY_LIMIT)] && $env(PROCESS_NEARBY_LIMIT) ne "" } {
    set process_nearby_limit [string trim $env(PROCESS_NEARBY_LIMIT)]
}
if { ![string is integer -strict $process_nearby_limit] } {
    set process_nearby_limit "50"
}

# Krok 1: NahrÃ¡t CSV soubor na vzdÃ¡lenÃ½ server pÅ™es SFTP
puts "ğŸ“¤ NahrÃ¡vÃ¡m CSV soubor na $env_label..."

spawn sftp -oIdentityFile=$identity -oIdentitiesOnly=yes ${user}@${sftp_host}

expect "Enter passphrase for key"
send "$password\r"

expect "sftp>"
send "put \"$csv_file\" \"$remote_csv_path\"\r"

expect "sftp>"
puts "âœ… CSV soubor nahrÃ¡n na $env_label: $remote_csv_path"
send "exit\r"

expect eof

# Krok 2: NahrÃ¡t safe-import skript do plugin directory
puts ""
puts "ğŸ” NahrÃ¡vÃ¡m import skript do plugin directory..."

set csv_dir [file dirname [file normalize $csv_file]]
set local_import_script "$csv_dir/safe-import-csv-staging.php"

spawn sftp -oIdentityFile=$identity -oIdentitiesOnly=yes ${user}@${sftp_host}

expect "Enter passphrase for key"
send "$password\r"

expect "sftp>"
send "cd wp-content/plugins/dobity-baterky\r"

expect "sftp>"
send "put \"$local_import_script\" \"safe-import-csv-staging.php\"\r"

expect "sftp>"
puts "âœ… Import skript nahrÃ¡n do plugin directory"
send "exit\r"

expect eof

# Krok 3: Spustit import v pozadÃ­ pomocÃ­ nohup (bez timeoutu)
puts ""
puts "ğŸš€ SpouÅ¡tÃ­m import na $env_label serveru v pozadÃ­..."

# PouÅ¾Ã­t nohup pro spuÅ¡tÄ›nÃ­ v pozadÃ­ + vÃ½stup do log souboru
set import_cmd "cd /srv/htdocs/wp-content/plugins/dobity-baterky && nohup php -d memory_limit=1024M safe-import-csv-staging.php \"$remote_csv_path\" --log-every=1000 --process-nearby=$process_nearby_limit > \"$log_file\" 2>&1 & echo \$!"

spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${ssh_host} $import_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    -re {(\d+)} {
        set pid $expect_out(1,string)
        puts "âœ… Import spuÅ¡tÄ›n v pozadÃ­ (PID: $pid)"
        puts "ğŸ“‹ Log soubor: $log_file"
        puts ""
        puts "ğŸ“Š Sledovat prÅ¯bÄ›h:"
        puts "   tail -f $log_file"
        exp_continue
    }
    eof {
        catch wait result
        set exit_code [lindex $result 3]
        exit $exit_code
    }
    timeout {
        puts "âš ï¸  Timeout pÅ™i spouÅ¡tÄ›nÃ­ (ale import moÅ¾nÃ¡ bÄ›Å¾Ã­ v pozadÃ­)"
        puts "ğŸ“‹ Zkontroluj log: $log_file"
        exit 0
    }
}

