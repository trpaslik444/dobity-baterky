#!/usr/bin/expect -f

# Usage: STAGING_PASS=heslo ./scripts/check-all-plugin-instances.expect

set timeout 120

if { ! [info exists env(STAGING_PASS)] || $env(STAGING_PASS) eq "" } {
    puts "ERROR: Nastav promƒõnnou STAGING_PASS s passphrase/heslem pro kl√≠ƒç."
    exit 2
}

set password $env(STAGING_PASS)

set user "staging-f576-dobitybaterky.wordpress.com"
set host "ssh.wp.com"
set identity "~/.ssh/id_ed25519_wpcom"

set check_cmd {cd /srv/htdocs 2>/dev/null || cd ~/public_html 2>/dev/null || pwd; echo "=== V≈†ECHNY INSTANCE PLUGINU ==="; ls -ld wp-content/plugins/dobity-baterky* 2>/dev/null | while read line; do dir=$(echo "$line" | awk '{print $NF}' | xargs basename); echo ""; echo "üìÅ Plugin slo≈æka: $dir"; if [ -f "wp-content/plugins/$dir/dobity-baterky.php" ]; then echo "  ‚úÖ Plugin soubor existuje"; echo "  üìÑ Verze:"; grep "Version:" "wp-content/plugins/$dir/dobity-baterky.php" | head -1 | sed 's/^/    /'; echo "  üìÖ Datum:"; echo "$line" | awk '{print "    ", $6, $7, $8}'; echo "  üìè Velikost core.js:"; if [ -f "wp-content/plugins/$dir/assets/map/core.js" ]; then ls -lh "wp-content/plugins/$dir/assets/map/core.js" | awk '{print "    ", $5}'; grep -n "NEMA≈ΩEME markery" "wp-content/plugins/$dir/assets/map/core.js" | head -1 | sed 's/^/    ≈ò√°dek: /' || echo "    ‚ùå Oprava NEMA≈ΩEME markery NEN√ç v t√©to verzi"; else echo "    ‚ùå core.js neexistuje"; fi; else echo "  ‚ùå Plugin soubor neexistuje"; fi; done; echo ""; echo "=== WP-CLI - KTER√ù PLUGIN JE AKTIVN√ç ==="; wp plugin list --name=dobity-baterky --format=table 2>/dev/null || echo "WP-CLI chyba"; echo ""; echo "=== WordPress active_plugins option ==="; wp option get active_plugins --format=json 2>/dev/null | grep -o "dobity-baterky/[^\"']*" || echo "Plugin nen√≠ v active_plugins"; echo ""; echo "=== Kter√Ω soubor WordPress skuteƒçnƒõ naƒç√≠t√° ==="; wp eval "echo plugin_dir_path(plugin_basename(DB_PLUGIN_FILE ?? '')) . PHP_EOL;" 2>/dev/null | grep "dobity-baterky" || wp eval "echo defined('DB_PLUGIN_DIR') ? DB_PLUGIN_DIR : 'DB_PLUGIN_DIR nen√≠ definov√°no' . PHP_EOL;" 2>/dev/null}

spawn ssh -i $identity -oIdentitiesOnly=yes ${user}@${host} $check_cmd

expect {
    "Enter passphrase for key" {
        send "$password\r"
        exp_continue
    }
    eof {
        catch wait result
        exit [lindex $result 3]
    }
    timeout {
        puts "‚ùå Timeout"
        exit 1
    }
}
